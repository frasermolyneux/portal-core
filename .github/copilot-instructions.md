# Copilot Instructions

- **Stack**: Terraform >= 1.14.3 with azurerm ~> 4.59 and azuread ~> 3.7; azurerm backend; OIDC auth for providers/backends; files live under terraform/.
- **Remote state dependencies**: platform-workloads supplies workload resource groups/backends, platform-monitoring provides Log Analytics workspace and monitor action groups, portal-environments adds API Management metadata, SQL admin group, and managed identities. Backend configs sit in terraform/backends/, coordinates passed via tfvars in terraform/tfvars/.
- **Resource naming/tagging**: See docs/tf-resource-standards.md; service plans named asp-{workload}-{env}-{location}-{key}, App Insights ai-portal-core-{env}-{location}, SQL server sql-portal-core-{env}-{location}-{random_id}, dashboards portal-core-{env}; apply var.tags everywhere.
- **Resources**: App service plans from var.app_service_plans map (sku/os_type per key); Application Insights wired to the shared Log Analytics workspace and IP masking disabled; MSSQL server with user-assigned identity from portal-environments outputs plus Azure AD admin group from portal-environments; firewall rule allows Azure services; monitor activity log alert for resource health uses critical vs informational action groups by environment.
- **Dashboards**: terraform/portal_dashboard.tf reads dashboards/dashboard.json and replaces tokens for subscription, resource group, app insights, app service plan (apps key), API Management name, and SQL server name; creates main dashboard and dev-only staging copy (staging ignores dashboard_properties changes). update-dashboard-from-staging workflow syncs staging to prod.
- **Shared data/helpers**: data.azurerm_resource_group.rg resolves from platform-workloads remote state; random_id.environment_id seeds unique SQL server names; time_rotating exists for future rotations; outputs expose app insights, service plans, sql server metadata, and staging dashboard name.
- **Workflows**: build-and-test (Dev plan on feature/bugfix/hotfix pushes), pr-verify (Dev plan always, Prd plan when run-prd-plan label; dependabot skipped), deploy-dev (manual Dev apply), deploy-prd (main + weekly schedule: Dev apply then Prd apply with concurrency guards), devops-secure-scanning scheduled, destroy-development/environment for teardown.
- **Local validation**: `terraform -chdir=terraform init -backend-config=backends/dev.backend.hcl` then `terraform -chdir=terraform plan -var-file=tfvars/dev.tfvars`; supply AZURE_CLIENT_ID, AZURE_TENANT_ID, AZURE_SUBSCRIPTION_ID and remote state coordinates in tfvars/backends.
- **Conventions**: Keep resources ASCII-named, prefer managed identities over secrets, ensure tags=var.tags, resource group deletion protection is disabled to allow App Insights artifacts cleanup.
- **Key files**: terraform/providers.tf, terraform/locals.tf, terraform/remote_state.tf, terraform/app_service_plan.tf, terraform/app_insights.tf, terraform/sql_server.tf, terraform/portal_dashboard.tf, terraform/resource_health_alerts.tf; docs/development-workflows.md and docs/tf-resource-standards.md capture process and naming guidance.
